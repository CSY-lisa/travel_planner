# 資料同步說明：fetch_data.js 是在做什麼？

## 一句話說明

這支程式負責把你在 **Google 試算表** 裡填的旅遊行程，自動搬到旅遊 App 裡顯示。你只需要更新試算表，App 的內容就會跟著更新——不需要手動複製貼上。

---

## 整體架構

```
你填寫的 Google 試算表
        ↓
   fetch_data.js（自動執行）
        ↓
   兩個 JSON 資料檔
        ↓
   旅遊 App 讀取並顯示
```

程式讀取兩張試算表，分別產生兩個檔案：

| 試算表 | 產出檔案 | 用途 |
|--------|----------|------|
| 主行程表 | `data/travel_data.json` | App 的每日行程頁面 |
| 補充資料表 | `data/reference_data.json` | App 的「補充資料」頁面 |

---

## 執行流程

### 第一步：連線取得試算表資料

程式透過 Google 試算表提供的「公開下載連結」，把整張表格的內容下載回來。格式是純文字（每格之間用 Tab 分隔，稱為 TSV 格式），就像把 Excel 另存成文字檔一樣。

### 第二步：解讀試算表內容

拿到原始文字後，程式逐行讀取，依照欄位名稱（第一列標題列）對應到正確的資訊。比方說看到「活動標題」這欄，就知道那格是事件名稱；看到「交通費用(JPY)」，就知道那格是票價。

### 第三步（僅限主行程表）：合併「多種交通方式」

試算表裡有一個特殊欄位叫 **群組ID**（例如 H001、H002）。

**用法**：同一段交通如果有多種方式（例如廣電、巴士、計程車都可以到同一個目的地），就在試算表裡寫多行，並且填上相同的群組ID。程式看到相同 ID 的多行，會自動把第二行、第三行合併為「備選方案」，讓 App 以「方法 1 / 方法 2 / 方法 3」的方式呈現。

```
試算表長這樣：
┌────────┬────────────┬──────┐
│ 活動標題 │  交通工具  │群組ID│
├────────┼────────────┼──────┤
│ 前往宮島 │  廣電 1號線 │ T001 │  ← 主項目（方法1）
│（空白） │  循環巴士  │ T001 │  ← 備選（方法2）
│（空白） │  廣島巴士  │ T001 │  ← 備選（方法3）
└────────┴────────────┴──────┘

App 呈現：
  方法 1 ⚡最快｜廣電 1號線
  方法 2      ｜循環巴士
  方法 3      ｜廣島巴士
```

### 第四步：整理成「天 → 時段 → 行程」的結構

程式把所有行程依照日期分組，再依照時段（早上 / 下午 / 晚上）細分，最終輸出一個有層次的資料檔，讓 App 可以按天、按時段顯示。

### 第五步：存成 JSON 檔案

處理完成後，將結果存成兩個 JSON 檔案（可以理解為結構化的資料倉庫），App 啟動時直接讀取這兩個檔案來渲染畫面。

---

## 主行程表擷取哪些欄位？

| 試算表欄位 | App 裡的用途 |
|-----------|-------------|
| 日期 | 判斷屬於哪一天 |
| 星期 | 顯示在標題旁（Mon. 等） |
| 時段 | 早上 / 下午 / 晚上分區 |
| 時間 | 每筆行程的開始時間 |
| 類型 | 交通 / 景點 / 用餐 / 購物 / 住宿 |
| 城市 | 顯示在行程卡上的城市標籤 |
| 活動標題 | 行程主標題（最大字） |
| 內容詳情 | 標題下方的說明文字 |
| 交通工具 | 具體路線名稱（如「廣電 1號線」） |
| 交通支付方式 | ICOCA / 現金 等 |
| 地點/導航 | 轉換成 Google Maps 內嵌連結 |
| 相關連結(時刻表) | 時刻表連結按鈕 |
| 起始站 | 出發站名 |
| 終點站 | 目的地站名 |
| 班次頻率/時刻資訊 | 幾分一班 |
| 移動時間 | 預估行程時間（用來排序最快方案） |
| 交通費用(JPY) | 票價顯示與費用加總 |
| 景點官網 | 景點官網連結按鈕 |
| 景點票價 (JPY) | 景點費用顯示與加總 |
| 營業時間/狀態 | 開放時段 |
| 景點簡介 | 折疊式 Highlights 區塊 |
| 景點建議停留時間 | 建議停留資訊 |
| 景點特殊狀況 | 紅色警示提示框 |
| 群組ID | 合併多種交通方案用（見第三步說明） |

---

## 補充資料表擷取哪些欄位？

| 試算表欄位 | App 裡的用途 |
|-----------|-------------|
| 類別 | 分類篩選器標籤（交通 / 餐廳 / 其他） |
| 城市 | 名稱旁的城市小標籤 |
| 名稱 | 卡片主標題 |
| 官網連結 | 官網連結按鈕 |
| 地點/導航 | Google Maps 內嵌連結 |
| 簡介 | 卡片說明文字 |
| 備註 | 灰色備注小字 |

---

## 何時執行？

| 執行方式 | 說明 |
|---------|------|
| **自動排程** | 每天台灣時間凌晨 4:00（UTC 20:00），GitHub 自動執行，結果存回 App |
| **手動執行** | 在電腦終端機輸入 `node scripts/fetch_data.js` 即可立即同步 |

手動執行前，需在專案根目錄有 `.env` 檔案，內含兩個試算表的網址設定。

---

## 如果試算表連線失敗？

- 主行程表連線失敗：程式會直接停止並顯示錯誤，不會更新資料（保留上次的版本）。
- 補充資料表連線失敗：程式會跳過，只更新主行程資料，並在 log 中留下警告。
